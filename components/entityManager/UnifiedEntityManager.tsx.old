import React, { useEffect, Suspense } from 'react'
import { UnifiedEntityConfig, UnifiedEntityManagerProps, BaseEntity, UnifiedFieldConfig, FieldDataType } from './types'
import { useEntityState } from './hooks/useEntityState'
import { useEntityApi } from './hooks/useEntityApi'
import { useEntityActions } from './hooks/useEntityActions'
import { EntityListView } from './components/EntityListView'

// Lazy load form components to improve performance
const EntityForm = React.lazy(() => import('./EntityForm').then(module => ({ default: module.EntityForm })))

// Helper function to map field types
const mapFieldType = (type: FieldDataType): 'text' | 'email' | 'password' | 'number' | 'tel' | 'url' | 'textarea' | 'select' | 'multiselect' | 'checkbox' | 'radio' | 'date' | 'datetime' | 'time' | 'file' | 'switch' | 'slider' | 'color' | 'json' => {
  const typeMap: Record<string, 'text' | 'email' | 'password' | 'number' | 'tel' | 'url' | 'textarea' | 'select' | 'multiselect' | 'checkbox' | 'radio' | 'date' | 'datetime' | 'time' | 'file' | 'switch' | 'slider' | 'color' | 'json'> = {
    'string': 'text',
    'number': 'number',
    'integer32': 'number',
    'integer64': 'number',
    'float': 'number',
    'double': 'number',
    'decimal': 'number',
    'date': 'date',
    'time': 'time',
    'boolean': 'checkbox',
    'select': 'select',
    'multiselect': 'multiselect',
    'array': 'json',
    'file': 'file',
    'image': 'file',
    'video': 'file',
    'textarea': 'textarea',
    'email': 'email',
    'password': 'password',
    'url': 'url',
    'uuid': 'text',
    'richtext': 'textarea',
    'object': 'json',
    'polymorphic': 'json',
    'hostname': 'text',
    'text': 'text',
    'tel': 'tel',
    'switch': 'switch',
    'geography': 'json',
    'custom': 'text',
  }
  return typeMap[type] || 'text'
}

// Loading fallback component
const LoadingFallback = () => (
  <div className="flex items-center justify-center p-8">
    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
  </div>
)

// Error boundary component
const ErrorFallback = ({ error, resetError }: { error: Error; resetError: () => void }) => (
  <div className="bg-red-50 border border-red-200 rounded-lg p-6">
    <h3 className="text-lg font-semibold text-red-800 mb-2">Something went wrong</h3>
    <p className="text-red-700 mb-4">{error.message}</p>
    <button
      onClick={resetError}
      className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
    >
      Try Again
    </button>
  </div>
)

// Delete confirmation dialog
interface DeleteDialogProps {
  isOpen: boolean
  onClose: () => void
  onConfirm: () => void
  title: string
  message: string
  isLoading?: boolean
}

const DeleteDialog: React.FC<DeleteDialogProps> = ({
  isOpen,
  onClose,
  onConfirm,
  title,
  message,
  isLoading = false
}) => {
  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 className="text-lg font-semibold text-gray-900 mb-2">{title}</h3>
        <p className="text-gray-700 mb-6">{message}</p>
        <div className="flex gap-3 justify-end">
          <button
            onClick={onClose}
            disabled={isLoading}
            className="px-4 py-2 text-gray-600 hover:text-gray-800 disabled:opacity-50"
          >
            Cancel
          </button>
          <button
            onClick={onConfirm}
            disabled={isLoading}
            className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50"
          >
            {isLoading ? 'Deleting...' : 'Delete'}
          </button>
        </div>
      </div>
    </div>
  )
}

// Bulk delete confirmation dialog
interface BulkDeleteDialogProps {
  isOpen: boolean
  onClose: () => void
  onConfirm: () => void
  count: number
  isLoading?: boolean
}

const BulkDeleteDialog: React.FC<BulkDeleteDialogProps> = ({
  isOpen,
  onClose,
  onConfirm,
  count,
  isLoading = false
}) => {
  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 className="text-lg font-semibold text-gray-900 mb-2">Delete Multiple Items</h3>
        <p className="text-gray-700 mb-6">
          Are you sure you want to delete {count} item{count !== 1 ? 's' : ''}? This action cannot be undone.
        </p>
        <div className="flex gap-3 justify-end">
          <button
            onClick={onClose}
            disabled={isLoading}
            className="px-4 py-2 text-gray-600 hover:text-gray-800 disabled:opacity-50"
          >
            Cancel
          </button>
          <button
            onClick={onConfirm}
            disabled={isLoading}
            className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50"
          >
            {isLoading ? 'Deleting...' : `Delete ${count} Item${count !== 1 ? 's' : ''}`}
          </button>
        </div>
      </div>
    </div>
  )
}

/**
 * Unified Entity Manager Component
 *
 * A comprehensive React component that provides a complete CRUD interface for managing entities.
 * Combines the best of MyLandlord's schema-driven architecture with EntityForm's variation-based approach.
 */
export const UnifiedEntityManager = <TEntity extends BaseEntity = BaseEntity>({
  config,
  initialMode = 'list',
  initialData,
  className = '',
  onModeChange,
  onAction,
  contextData,
}: UnifiedEntityManagerProps<TEntity>) => {
  // Initialize hooks
  const { state, actions: stateActions } = useEntityState({
    config,
    initialMode,
    initialData,
  })

  const apiActions = useEntityApi({
    config,
    state,
    actions: stateActions,
  })

  const entityActions = useEntityActions({
    config,
    state,
    actions: stateActions,
    apiActions,
  })

  // Effect to notify parent of mode changes
  useEffect(() => {
    onModeChange?.(state.currentMode, state.selectedItem || undefined)
  }, [state.currentMode, state.selectedItem, onModeChange])

  // Render content based on current mode
  const renderContent = () => {
    switch (state.currentMode) {
      case 'create':
      case 'edit':
        return (
          <Suspense fallback={<LoadingFallback />}>
            <EntityForm
              config={{
                mode: state.currentMode,
                layout: (config.formView?.layout === 'single-column' || config.formView?.layout === 'two-column') ? 'grid' : (config.formView?.layout as 'vertical' | 'horizontal' | 'grid') || 'grid',
                columns: config.formView?.columns || 2,
                fieldSpacing: config.formView?.fieldSpacing || 'md',
                submitButtonText: config.formView?.submitButtonText || (state.currentMode === 'create' ? 'Create' : 'Update'),
                cancelButtonText: config.formView?.cancelButtonText || 'Cancel',
                validateOnChange: config.formView?.validateOnChange ?? true,
                validateOnBlur: config.formView?.validateOnBlur ?? true,
                showProgress: config.formView?.showProgress ?? false,
                fields: config.fields.map(field => ({
                  name: field.name,
                  label: field.label,
                  type: mapFieldType(field.type),
                  required: field.required,
                  disabled: field.disabled,
                  placeholder: field.placeholder,
                  description: field.description,
                  validation: field.validation,
                  options: field.options,
                  multiple: field.multiple,
                  min: field.min,
                  max: field.max,
                  minLength: field.minLength,
                  maxLength: field.maxLength,
                  pattern: typeof field.pattern === 'string' ? field.pattern : field.pattern?.source,
                  width: field.gridSpan === 'full' ? '100%' : field.gridSpan === 'half' ? '50%' : '33.33%',
                })),
              }}
              data={state.formData}
              onSubmit={(data: Record<string, unknown>) => entityActions.handleFormSubmit(data as Partial<TEntity>)}
              onCancel={entityActions.handleFormCancel}
              loading={state.isLoading}
            />
          </Suspense>
        )

      case 'view':
        if (!state.selectedItem) {
          return (
            <div className="text-center py-12">
              <p className="text-gray-500">No item selected for viewing</p>
              <button
                onClick={() => stateActions.setMode('list')}
                className="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
              >
                Back to List
              </button>
            </div>
          )
        }

        return (
          <div className="bg-white rounded-lg shadow p-6">
            <div className="flex items-center justify-between mb-6">
              <h2 className="text-2xl font-bold text-gray-900">
                {config.displayName} Details
              </h2>
              <div className="flex gap-2">
                {config.permissions?.update && (
                  <button
                    onClick={() => state.selectedItem && entityActions.handleEdit(state.selectedItem)}
                    className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                  >
                    Edit
                  </button>
                )}
                <button
                  onClick={() => stateActions.setMode('list')}
                  className="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
                >
                  Back to List
                </button>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {config.fields.map((field: UnifiedFieldConfig) => (
                <div key={field.name} className="space-y-1">
                  <label className="block text-sm font-medium text-gray-700">
                    {field.label}
                  </label>
                  <div className="text-sm text-gray-900">
                    {state.selectedItem && (
                      field.customRenderer
                        ? field.customRenderer(state.selectedItem[field.name], state.selectedItem)
                        : field.displayFormat
                          ? field.displayFormat(state.selectedItem[field.name])
                          : String(state.selectedItem[field.name] || 'N/A')
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
        )

      case 'list':
      default:
        return (
          <EntityListView
            config={config}
            state={state}
            actions={stateActions}
            data={{
              results: state.items,
              count: state.totalCount,
              next: state.hasNextPage ? 'next' : null,
              previous: state.hasPrevPage ? 'previous' : null,
            }}
            isLoading={state.isLoading}
            error={state.error}
            variant={config.listView?.variant || 'table'}
            contextData={contextData}
          />
        )
    }
  }

  return (
    <div className={`unified-entity-manager ${className}`}>
      {/* Error display */}
      {state.error && state.currentMode === 'list' && (
        <div className="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
          <div className="flex items-center justify-between">
            <p className="text-red-800">{state.error}</p>
            <button
              onClick={() => stateActions.setError(null)}
              className="text-red-600 hover:text-red-800"
              title="Dismiss error"
            >
              Ã—
            </button>
          </div>
        </div>
      )}

      {/* Main content */}
      {renderContent()}

      {/* Delete confirmation dialogs */}
      <DeleteDialog
        isOpen={state.showDeleteDialog}
        onClose={() => stateActions.setShowDeleteDialog(false)}
        onConfirm={entityActions.handleConfirmDelete}
        title={`Delete ${config.displayName}`}
        message={`Are you sure you want to delete this ${config.displayName.toLowerCase()}? This action cannot be undone.`}
        isLoading={state.isLoading}
      />

      <BulkDeleteDialog
        isOpen={state.showBulkDeleteDialog}
        onClose={() => stateActions.setShowBulkDeleteDialog(false)}
        onConfirm={entityActions.handleConfirmBulkDelete}
        count={state.selectedIds.length}
        isLoading={state.isLoading}
      />
    </div>
  )
}

// Helper function to create entity manager configuration from EntityForm variation
export function createEntityManagerConfigFromVariation(
  variation: any, // EntityFormConfig
  entityName: string,
  endpoints: {
    list: string
    create: string
    update: string
    delete: string
  }
): UnifiedEntityConfig {
  return {
    name: entityName.toLowerCase(),
    namePlural: `${entityName.toLowerCase()}s`,
    displayName: entityName,
    fields: variation.fields.map((field: any) => ({
      name: field.name,
      label: field.label,
      type: field.type,
      required: field.required,
      disabled: field.disabled,
      placeholder: field.placeholder,
      description: field.description,
      validation: field.validation,
      options: field.options,
      multiple: field.multiple,
      min: field.min,
      max: field.max,
      minLength: field.minLength,
      maxLength: field.maxLength,
      pattern: field.pattern,
      icon: field.icon,
      gridSpan: field.width === 'full' ? 'full' : field.width === 'half' ? 'half' : 'third',
      searchable: true,
      filterable: true,
      sortable: true,
      exportable: true,
    })),
    endpoints,
    listView: {
      enableSearch: true,
      enableFilters: true,
      enableSorting: true,
      enablePagination: true,
      enableSelection: true,
      enableBulkActions: true,
      enableExport: true,
      variant: 'table',
      pageSize: 10,
    },
    formView: {
      layout: variation.layout,
      columns: variation.columns,
      fieldSpacing: variation.fieldSpacing,
      submitButtonText: variation.submitButtonText,
      cancelButtonText: variation.cancelButtonText,
      validateOnChange: variation.validateOnChange,
      validateOnBlur: variation.validateOnBlur,
      showProgress: variation.showProgress,
      mode: variation.mode,
    },
    permissions: {
      create: true,
      read: true,
      update: true,
      delete: true,
      export: true,
    },
  }
}